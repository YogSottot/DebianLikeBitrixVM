---
- name: Check if UFW service is present # noqa command-instead-of-module
  ansible.builtin.command:
    cmd: systemctl cat ufw.service
  failed_when: false
  changed_when: false
  register: ufw_service

- name: Disable UFW
  ansible.builtin.systemd:
    name: ufw
    enabled: false
    state: stopped
    masked: true
  when: ufw_service.rc == 0

- name: Delete UFW
  ansible.builtin.package:
    name: ufw
    state: absent
  when: ufw_service.rc == 0

# Ubuntu doesn't have /etc/protocols by default in Docker
- name: Install firewalld dependencies
  ansible.builtin.package:
    name: "{{ packages }}"
    state: latest
  vars:
    packages:
      - netbase
  when: ansible_os_family == "Debian"

- name: Install firewalld
  ansible.builtin.package:
    name: firewalld
    state: present
  register: installed_firewalld

- name: Ensure firewalld is running and enabled on boot
  ansible.builtin.service:
    name: firewalld
    state: started
    enabled: true
  when: not marcelnijenhof_firewalld_disable

- name: Ensure firewalld is stopped and disabled on boot
  ansible.builtin.service:
    name: firewalld
    state: stopped
    enabled: false
  when: marcelnijenhof_firewalld_disable

- name: Configure firewalld zones from vars
  ansible.posix.firewalld:
    source: "{{ item.source }}"
    zone: "{{ item.zone }}"
    # interface: "{{ item.interface }}"
    state: "{{ item.state | default('enabled') }}"
    permanent: "{{ item.permanent | default(true) }}"
    # immediate: "{{ item.immediate | default(true) }}"
  with_items: "{{ marcelnijenhof_firewalld_zones }}"
  notify: Firewalld complete reload
  when: not marcelnijenhof_firewalld_disable

- name: Add firewalld rules for services from vars
  ansible.posix.firewalld:
    service: "{{ item.service }}"
    zone: "{{ item.zone | default('public') }}"
    permanent: "{{ item.permanent | default(true) }}"
    state: "{{ item.state | default('enabled') }}"
    immediate: "{{ item.immediate | default(true) }}"
  with_items: "{{ marcelnijenhof_firewalld_allow_services }}"
  notify: Firewalld complete reload
  when: not marcelnijenhof_firewalld_disable

- name: Add firewalld rules for ports from vars
  ansible.posix.firewalld:
    port: "{{ item.port }}"
    zone: "{{ item.zone | default('public') }}"
    permanent: "{{ item.permanent | default(true) }}"
    state: "{{ item.state | default('enabled') }}"
    immediate: "{{ item.immediate | default(true) }}"
  with_items: "{{ marcelnijenhof_firewalld_allow_ports }}"
  notify: Firewalld complete reload
  when: not marcelnijenhof_firewalld_disable
