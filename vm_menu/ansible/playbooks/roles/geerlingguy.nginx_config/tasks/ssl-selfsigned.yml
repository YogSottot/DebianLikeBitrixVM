---
- name: Create a directory if it does not exist
  ansible.builtin.file:
    path: "{{ nginx_conf_main_directory }}/ssl/"
    state: directory
    mode: "0755"

- name: Install crypto deps
  ansible.builtin.package:
    name: python3-cryptography
    state: present

- name: Generate Private Key
  community.crypto.openssl_privatekey:
    path: "{{ nginx_conf_main_directory }}/ssl/cert.key"
    force: false

- name: Generate Certificate Sign Request (CSR)
  community.crypto.openssl_csr:
    path: "{{ nginx_conf_main_directory }}/ssl/ansible.com.csr"
    privatekey_path: "{{ nginx_conf_main_directory }}/ssl/cert.key"
    common_name: Bitrix
    organization_name: Bitrix, Inc.
    force: false

- name: Generate self-signed SSL certificates
  community.crypto.x509_certificate:
    path: "{{ nginx_conf_main_directory }}/ssl/cert.pem"
    privatekey_path: "{{ nginx_conf_main_directory }}/ssl/cert.key"
    csr_path: "{{ nginx_conf_main_directory }}/ssl/ansible.com.csr"
    provider: selfsigned
    force: false

- name: Generate X bit dhparam.pem file (this may take a while)
  community.crypto.openssl_dhparam:
    path: "{{ nginx_conf_main_directory }}/ssl/dhparam.pem"
    size: 2048
    force: false
